#include "osd_font.h"
#include "osd.h"

// Basic 8x8 ASCII font (characters 32-127)
// For now, including essential characters for menu system
const uint8_t osd_font_8x8[256][8] = {
    //
    [' '] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['!'] = {0x00, 0x10, 0x10, 0x10, 0x10, 0x00, 0x10, 0x00},
    ['"'] = {0x00, 0x24, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['#'] = {0x00, 0x24, 0x7E, 0x24, 0x24, 0x7E, 0x24, 0x00},
    ['$'] = {0x00, 0x08, 0x3E, 0x28, 0x3E, 0x0A, 0x3E, 0x08},
    ['%'] = {0x00, 0x62, 0x64, 0x08, 0x10, 0x26, 0x46, 0x00},
    ['&'] = {0x00, 0x10, 0x28, 0x10, 0x2A, 0x44, 0x3A, 0x00},
    ['\''] = {0x00, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['('] = {0x00, 0x04, 0x08, 0x08, 0x08, 0x08, 0x04, 0x00},
    [')'] = {0x00, 0x20, 0x10, 0x10, 0x10, 0x10, 0x20, 0x00},
    ['*'] = {0x00, 0x00, 0x14, 0x08, 0x3E, 0x08, 0x14, 0x00},
    ['+'] = {0x00, 0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00},
    [','] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x10},
    ['-'] = {0x00, 0x00, 0x00, 0x00, 0x3E, 0x00, 0x00, 0x00},
    ['.'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},
    ['/'] = {0x00, 0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x00},
    // Numbers 48-57 (0-9)
    ['0'] = {0x00, 0x3C, 0x46, 0x4A, 0x52, 0x62, 0x3C, 0x00},
    ['1'] = {0x00, 0x18, 0x28, 0x08, 0x08, 0x08, 0x3E, 0x00},
    ['2'] = {0x00, 0x3C, 0x42, 0x02, 0x3C, 0x40, 0x7E, 0x00},
    ['3'] = {0x00, 0x3C, 0x42, 0x0C, 0x02, 0x42, 0x3C, 0x00},
    ['4'] = {0x00, 0x08, 0x18, 0x28, 0x48, 0x7E, 0x08, 0x00},
    ['5'] = {0x00, 0x7E, 0x40, 0x7C, 0x02, 0x42, 0x3C, 0x00},
    ['6'] = {0x00, 0x3C, 0x40, 0x7C, 0x42, 0x42, 0x3C, 0x00},
    ['7'] = {0x00, 0x7E, 0x02, 0x04, 0x08, 0x10, 0x10, 0x00},
    ['8'] = {0x00, 0x3C, 0x42, 0x3C, 0x42, 0x42, 0x3C, 0x00},
    ['9'] = {0x00, 0x3C, 0x42, 0x42, 0x3E, 0x02, 0x3C, 0x00},
    // Punctuation and symbols
    [':'] = {0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x00},
    [';'] = {0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x10, 0x20},
    ['<'] = {0x00, 0x00, 0x04, 0x08, 0x10, 0x08, 0x04, 0x00},
    ['='] = {0x00, 0x00, 0x00, 0x3E, 0x00, 0x3E, 0x00, 0x00},
    ['>'] = {0x00, 0x00, 0x10, 0x08, 0x04, 0x08, 0x10, 0x00},
    ['?'] = {0x00, 0x3C, 0x42, 0x04, 0x08, 0x00, 0x08, 0x00},
    ['@'] = {0x00, 0x3C, 0x4A, 0x56, 0x5E, 0x40, 0x3C, 0x00},
    // Letters A-Z (65-90)
    ['A'] = {0x00, 0x3C, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x00},
    ['B'] = {0x00, 0x7C, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0x00},
    ['C'] = {0x00, 0x3C, 0x42, 0x40, 0x40, 0x42, 0x3C, 0x00},
    ['D'] = {0x00, 0x78, 0x44, 0x42, 0x42, 0x44, 0x78, 0x00},
    ['E'] = {0x00, 0x7E, 0x40, 0x7C, 0x40, 0x40, 0x7E, 0x00},
    ['F'] = {0x00, 0x7E, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x00},
    ['G'] = {0x00, 0x3C, 0x42, 0x40, 0x4E, 0x42, 0x3C, 0x00},
    ['H'] = {0x00, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00},
    ['I'] = {0x00, 0x3E, 0x08, 0x08, 0x08, 0x08, 0x3E, 0x00},
    ['J'] = {0x00, 0x02, 0x02, 0x02, 0x42, 0x42, 0x3C, 0x00},
    ['K'] = {0x00, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0x00},
    ['L'] = {0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x00},
    ['M'] = {0x00, 0x42, 0x66, 0x5A, 0x42, 0x42, 0x42, 0x00},
    ['N'] = {0x00, 0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x00},
    ['O'] = {0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00},
    ['P'] = {0x00, 0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x00},
    ['Q'] = {0x00, 0x3C, 0x42, 0x42, 0x52, 0x4A, 0x3C, 0x00},
    ['R'] = {0x00, 0x7C, 0x42, 0x42, 0x7C, 0x44, 0x42, 0x00},
    ['S'] = {0x00, 0x3C, 0x40, 0x3C, 0x02, 0x42, 0x3C, 0x00},
    ['T'] = {0x00, 0xFE, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00},
    ['U'] = {0x00, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00},
    ['V'] = {0x00, 0x42, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00},
    ['W'] = {0x00, 0x42, 0x42, 0x42, 0x42, 0x5A, 0x24, 0x00},
    ['X'] = {0x00, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42, 0x00},
    ['Y'] = {0x00, 0x82, 0x44, 0x28, 0x10, 0x10, 0x10, 0x00},
    ['Z'] = {0x00, 0x7E, 0x04, 0x08, 0x10, 0x20, 0x7E, 0x00},
    // Lowercase letters (97-122)
    ['a'] = {0x00, 0x00, 0x38, 0x04, 0x3C, 0x44, 0x3C, 0x00},
    ['b'] = {0x00, 0x20, 0x20, 0x3C, 0x22, 0x22, 0x3C, 0x00},
    ['c'] = {0x00, 0x00, 0x1C, 0x20, 0x20, 0x20, 0x1C, 0x00},
    ['d'] = {0x00, 0x04, 0x04, 0x3C, 0x44, 0x44, 0x3C, 0x00},
    ['e'] = {0x00, 0x00, 0x38, 0x44, 0x78, 0x40, 0x3C, 0x00},
    ['f'] = {0x00, 0x0C, 0x10, 0x18, 0x10, 0x10, 0x10, 0x00},
    ['g'] = {0x00, 0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x38},
    ['h'] = {0x00, 0x40, 0x40, 0x78, 0x44, 0x44, 0x44, 0x00},
    ['i'] = {0x00, 0x10, 0x00, 0x30, 0x10, 0x10, 0x38, 0x00},
    ['j'] = {0x00, 0x04, 0x00, 0x04, 0x04, 0x04, 0x24, 0x18},
    ['k'] = {0x00, 0x20, 0x28, 0x30, 0x30, 0x28, 0x24, 0x00},
    ['l'] = {0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0C, 0x00},
    ['m'] = {0x00, 0x00, 0x68, 0x54, 0x54, 0x54, 0x54, 0x00},
    ['n'] = {0x00, 0x00, 0x78, 0x44, 0x44, 0x44, 0x44, 0x00},
    ['o'] = {0x00, 0x00, 0x38, 0x44, 0x44, 0x44, 0x38, 0x00},
    ['p'] = {0x00, 0x00, 0x78, 0x44, 0x44, 0x78, 0x40, 0x40},
    ['q'] = {0x00, 0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x06},
    ['r'] = {0x00, 0x00, 0x1C, 0x20, 0x20, 0x20, 0x20, 0x00},
    ['s'] = {0x00, 0x00, 0x38, 0x40, 0x38, 0x04, 0x78, 0x00},
    ['t'] = {0x00, 0x10, 0x38, 0x10, 0x10, 0x10, 0x0C, 0x00},
    ['u'] = {0x00, 0x00, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00},
    ['v'] = {0x00, 0x00, 0x44, 0x44, 0x28, 0x28, 0x10, 0x00},
    ['w'] = {0x00, 0x00, 0x44, 0x54, 0x54, 0x54, 0x28, 0x00},
    ['x'] = {0x00, 0x00, 0x44, 0x28, 0x10, 0x28, 0x44, 0x00},
    ['y'] = {0x00, 0x00, 0x44, 0x44, 0x44, 0x3C, 0x04, 0x38},
    ['z'] = {0x00, 0x00, 0x7C, 0x08, 0x10, 0x20, 0x7C, 0x00},
    ['['] = {0x00, 0x0E, 0x08, 0x08, 0x08, 0x08, 0x0E, 0x00},
    // Special characters
    ['\\'] = {0x00, 0x00, 0x40, 0x20, 0x10, 0x08, 0x04, 0x00},
    [']'] = {0x00, 0x70, 0x10, 0x10, 0x10, 0x10, 0x70, 0x00},
    ['^'] = {0x00, 0x10, 0x38, 0x54, 0x10, 0x10, 0x10, 0x00},
    ['_'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF},
    ['`'] = {0x00, 0x1C, 0x22, 0x78, 0x20, 0x20, 0x7E, 0x00},
    ['{'] = {0x00, 0x00, 0x08, 0x08, 0x76, 0x42, 0x42, 0x00},
    ['|'] = {0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00},
    ['}'] = {0x00, 0x42, 0x42, 0x76, 0x08, 0x08, 0x00, 0x00},
    ['~'] = {0x00, 0x14, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00},
};

void osd_draw_char(uint8_t *buffer, uint16_t buf_width, uint16_t x, uint16_t y,
                   char c, uint8_t fg_color, uint8_t bg_color)
{
#ifdef OSD_MENU_ENABLED
    if (c < 0 || c > 255)
        return;

    const uint8_t *char_data = osd_font_8x8[(uint8_t)c];

    for (int row = 0; row < 8; row++)
    {
        uint8_t line = char_data[row];
        for (int col = 0; col < 8; col++)
        {
            uint16_t px = x + col;
            uint16_t py = y + row;

            // Check bounds
            if (px >= buf_width || py >= OSD_HEIGHT)
                continue;

            // Calculate buffer position (2 pixels per byte)
            int buffer_offset = py * (buf_width / 2) + (px / 2);
            if (buffer_offset >= OSD_BUFFER_SIZE)
                continue;

            // Determine pixel color
            uint8_t pixel_color = (line & (0x80 >> col)) ? fg_color : bg_color;

            // Set pixel in buffer (2 pixels per byte)
            if (px & 1)
            {
                // Odd pixel (upper 4 bits)
                buffer[buffer_offset] = (buffer[buffer_offset] & 0x0F) | (pixel_color << 4);
            }
            else
            {
                // Even pixel (lower 4 bits)
                buffer[buffer_offset] = (buffer[buffer_offset] & 0xF0) | (pixel_color & 0x0F);
            }
        }
    }
#endif
}

void osd_draw_string(uint8_t *buffer, uint16_t buf_width, uint16_t x, uint16_t y,
                     const char *str, uint8_t fg_color, uint8_t bg_color)
{
#ifdef OSD_MENU_ENABLED
    uint16_t cur_x = x;
    while (*str && cur_x < buf_width - 8)
    {
        osd_draw_char(buffer, buf_width, cur_x, y, *str, fg_color, bg_color);
        cur_x += 8; // ZX Spectrum: 8 pixels per character (no extra spacing)
        str++;
    }
#endif
}

void osd_draw_string_centered(uint8_t *buffer, uint16_t buf_width, uint16_t y,
                              const char *str, uint8_t fg_color, uint8_t bg_color)
{
#ifdef OSD_MENU_ENABLED
    int len = strlen(str);
    int start_x = (buf_width - (len * 8)) / 2; // ZX Spectrum: 8 pixels per character
    if (start_x < 0)
        start_x = 0;

    osd_draw_string(buffer, buf_width, start_x, y, str, fg_color, bg_color);
#endif
}
